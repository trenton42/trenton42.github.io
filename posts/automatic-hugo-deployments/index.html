<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-us" lang="en-us">
<head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta http-equiv="X-Clacks-Overhead" content="GNU Terry Pratchett" />
  <meta name="generator" content="Hugo 0.76.5" />

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>Automatic Hugo Site Deployments With CircleCI &middot; Trenton Broughton</title>

  
  <link rel="stylesheet" href="https://ikso.us/css/print.css" media="print">
  <link rel="stylesheet" href="https://ikso.us/css/poole.css">
  <link rel="stylesheet" href="https://ikso.us/css/syntax.css">
  <link rel="stylesheet" href="https://ikso.us/css/hyde.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700">

  
  <link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192"  href="/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/manifest.json">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">
  
  <link href="" rel="alternate" type="application/rss+xml" title="Trenton Broughton" />
  
  <script type="text/javascript">(function(c,a){if(!a.__SV){var b=window;try{var d,m,j,k=b.location,f=k.hash;d=function(a,b){return(m=a.match(RegExp(b+"=([^&]*)")))?m[1]:null};f&&d(f,"state")&&(j=JSON.parse(decodeURIComponent(d(f,"state"))),"mpeditor"===j.action&&(b.sessionStorage.setItem("_mpcehash",f),history.replaceState(j.desiredHash||"",c.title,k.pathname+k.search)))}catch(n){}var l,h;window.mixpanel=a;a._i=[];a.init=function(b,d,g){function c(b,i){var a=i.split(".");2==a.length&&(b=b[a[0]],i=a[1]);b[i]=function(){b.push([i].concat(Array.prototype.slice.call(arguments,
  0)))}}var e=a;"undefined"!==typeof g?e=a[g]=[]:g="mixpanel";e.people=e.people||[];e.toString=function(b){var a="mixpanel";"mixpanel"!==g&&(a+="."+g);b||(a+=" (stub)");return a};e.people.toString=function(){return e.toString(1)+".people (stub)"};l="disable time_event track track_pageview track_links track_forms track_with_groups add_group set_group remove_group register register_once alias unregister identify name_tag set_config reset opt_in_tracking opt_out_tracking has_opted_in_tracking has_opted_out_tracking clear_opt_in_out_tracking people.set people.set_once people.unset people.increment people.append people.union people.track_charge people.clear_charges people.delete_user people.remove".split(" ");
  for(h=0;h<l.length;h++)c(e,l[h]);var f="set set_once union unset remove delete".split(" ");e.get_group=function(){function a(c){b[c]=function(){call2_args=arguments;call2=[c].concat(Array.prototype.slice.call(call2_args,0));e.push([d,call2])}}for(var b={},d=["get_group"].concat(Array.prototype.slice.call(arguments,0)),c=0;c<f.length;c++)a(f[c]);return b};a._i.push([b,d,g])};a.__SV=1.2;b=c.createElement("script");b.type="text/javascript";b.async=!0;b.src="undefined"!==typeof MIXPANEL_CUSTOM_LIB_URL?
  MIXPANEL_CUSTOM_LIB_URL:"file:"===c.location.protocol&&"//cdn4.mxpnl.com/libs/mixpanel-2-latest.min.js".match(/^\/\//)?"https://cdn4.mxpnl.com/libs/mixpanel-2-latest.min.js":"//cdn4.mxpnl.com/libs/mixpanel-2-latest.min.js";d=c.getElementsByTagName("script")[0];d.parentNode.insertBefore(b,d)}})(document,window.mixpanel||[]);
  mixpanel.init("91c8afbed5c11f8feee5b2d5f28de5d5");</script>
  
</head>

  <body class=" ">
  <div class="sidebar" id="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="https://ikso.us/"><h1>Trenton Broughton</h1></a>
      <p class="lead">
       danger: high entropy 
      </p>
    </div>

    <ul class="sidebar-nav">
      <li><a href="https://ikso.us/">Home</a> </li>
      <li><a href="/posts/about/"> About Me </a></li><li><a href="/posts/"> Blahg Posts </a></li><li><a href="/machine/"> Machine </a></li>
    </ul>

    <p>&copy; 2020. All rights reserved. </p>
  </div>
</div>

    <div class="content container">
    <div class="post">
  <h1>Automatic Hugo Site Deployments With CircleCI</h1>
  <span class="post-date">Sun, Dec 30, 2018</span>
  
  <a class="post-tag" href='/tags/code'>code</a>
  <a class="post-tag" href='/tags/hugo'>hugo</a> <p>Generating static sites with Hugo is easy enough, but I wanted something a little more automated. I also wanted to deploy my site to Github Pages from another computer (or even my phone) without needing to run the hugo command locally and pushing the generated code back to Github. If you are unfamiliar with Github Pages, check out the <a href="https://pages.github.com/">introduction</a>.</p>
<h2 id="prep-work----getting-things-set-up">Prep Work &ndash; Getting Things Set Up</h2>
<p><a href="https://circleci.com/">CircleCI</a> uses Docker containers to run CI jobs, so I knew that I would need a Hugo image to build my site. There are quite a few listed on Docker Hub, but for completeness, I went ahead and set up my own. This step can be skipped, just specify which ever image you wish to use in your CircleCI configuration file.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-dockerfile" data-lang="dockerfile"><span style="color:#66d9ef">FROM</span><span style="color:#e6db74"> debian:stretch</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> apt-get update <span style="color:#f92672">&amp;&amp;</span> apt-get install -y git ssh curl<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">ARG</span> HUGO_VERSION<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;0.53&#34;</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">RUN</span> curl -L -o hugo.deb <span style="color:#e6db74">&#34;https://github.com/gohugoio/hugo/releases/download/v</span><span style="color:#e6db74">${</span>HUGO_VERSION<span style="color:#e6db74">}</span><span style="color:#e6db74">/hugo_extended_</span><span style="color:#e6db74">${</span>HUGO_VERSION<span style="color:#e6db74">}</span><span style="color:#e6db74">_Linux-64bit.deb&#34;</span> <span style="color:#f92672">&amp;&amp;</span> dpkg -i hugo.deb<span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">WORKDIR</span><span style="color:#e6db74"> /site</span><span style="color:#960050;background-color:#1e0010">
</span><span style="color:#960050;background-color:#1e0010"></span><span style="color:#66d9ef">CMD</span> [<span style="color:#960050;background-color:#1e0010">hugo</span>]<span style="color:#960050;background-color:#1e0010">
</span></code></pre></div><p>This <a href="https://github.com/trenton42/hugo-extended-docker">git repo</a> is built automatically by Docker Hub, and results in the image <a href="https://hub.docker.com/r/trenton/hugo-extended">trenton/hugo-extended</a>.</p>
<h2 id="building-the-pipeline">Building the Pipeline</h2>
<h3 id="what-the-pipeline-will-do">What the Pipeline Will Do</h3>
<p>The process that this pipeline will follow should be something like this:</p>
<ol>
<li>Checkout the new changes from Github</li>
<li>Checkout the output branch (<code>master</code> in my case) to another directory</li>
<li>Run Hugo to render the site sending the output to the directory containing my output branch</li>
<li>If we are going to publish, commit any changes to the output branch, and push them back to Github</li>
</ol>
<h3 id="pipeline-goals">Pipeline Goals</h3>
<p>I had a couple of goals for my pipeline deployments:</p>
<ol>
<li>I want to test that any branch generates without errors.</li>
<li>I only want my main branch (which is called content) to actually publish my site.</li>
<li>I don&rsquo;t want rendered content to trigger CI builds.</li>
<li>I don&rsquo;t want the pipeline to attempt to deploy if nothing has actually changed.</li>
</ol>
<h3 id="the-pipeline">The Pipeline</h3>
<p>My final pipeline is rather lengthy, so I will not copy it in its entirety here. You can view it on this site&rsquo;s <a href="https://github.com/trenton42/trenton42.github.io/blob/content/.circleci/config.yml">Github Repo</a>. I will point out a few key areas that relate to my goals, though.</p>
<p>The <code>workflows</code> section controls what jobs are actually run and when:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml"><span style="color:#f92672">workflows</span>:
  <span style="color:#f92672">version</span>: <span style="color:#ae81ff">2</span>
  <span style="color:#f92672">build_and_deploy</span>:
    <span style="color:#f92672">jobs</span>:
      - <span style="color:#ae81ff">build</span> <span style="color:#75715e"># This job will run on any branch and fulfils goal ⓵</span>
      - <span style="color:#f92672">deploy</span>:
          <span style="color:#f92672">requires</span>:
            - <span style="color:#ae81ff">build</span>
          <span style="color:#f92672">filters</span>:
            <span style="color:#f92672">branches</span>:
              <span style="color:#f92672">only</span>: <span style="color:#ae81ff">content</span> <span style="color:#75715e"># The deploy job will only run on the main branch for goal ⓶</span>
</code></pre></div><p>In order to prevent the pipeline to attempt to run on my generated branch, I add the text <code>[ci skip]</code> to the commit message on my generated branch (goal ⓷).</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">git add . <span style="color:#f92672">&amp;&amp;</span> git commit -m <span style="color:#e6db74">&#34;Automatic deployment [ci skip]&#34;</span> <span style="color:#f92672">&amp;&amp;</span> git push
</code></pre></div><p>Finally, to check if anything has changed (goal ⓸), I wrapped the entire command in an if statement:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#66d9ef">if</span> <span style="color:#f92672">[[</span> -n <span style="color:#66d9ef">$(</span>git status --porcelain<span style="color:#66d9ef">)</span> <span style="color:#f92672">]]</span>; <span style="color:#66d9ef">then</span>
</code></pre></div><h3 id="side-notes">Side Notes</h3>
<p>You might have noticed that I add an ssh key in one of the steps:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-yaml" data-lang="yaml">- <span style="color:#f92672">add_ssh_keys</span>:
    <span style="color:#f92672">fingerprints</span>:
        - <span style="color:#e6db74">&#34;cc:c9:30:35:0a:9e:22:50:67:2f:e4:61:74:6e:9b:4c&#34;</span>
</code></pre></div><p>This is because CircleCI will create a read only key to checkout and test your code, but I need to make a commit and push back to Github. To get around this, I created another <a href="https://help.github.com/articles/adding-a-new-ssh-key-to-your-github-account/">deploy key</a> with write permissions to this repository. If you follow these steps, you will need to change the fingerprint to match your own deploy key.</p>
<p>You also will see that there is a <code>save_cache</code> step and a <code>restore_cache</code> step in the two jobs. This is because each job runs in an isolated container, and has no persistent state that is preserved between the jobs. Using the cache allows me to avoid building the site twice (once in each step).</p>
<h2 id="finished">Finished!</h2>
<p>That&rsquo;s it! Now I can write a post or update templates directly on Github without needing to checkout the changes and run Hugo manually. Feel free to use and adapt this pipeline to suit your needs.</p>

</div>


    </div>

    
    
    <script>
      mixpanel.track("Page View", {page: "\/posts\/automatic-hugo-deployments\/"});
    </script>
    
  </body>
</html>