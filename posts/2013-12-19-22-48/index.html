<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-us" lang="en-us">
<head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta http-equiv="X-Clacks-Overhead" content="GNU Terry Pratchett" />
  <meta name="generator" content="Hugo 0.53" />

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>Attaching StringIO Data to a Mailgun Message &middot; Trenton Broughton</title>

  
  <link rel="stylesheet" href="https://ikso.us/css/print.css" media="print">
  <link rel="stylesheet" href="https://ikso.us/css/poole.css">
  <link rel="stylesheet" href="https://ikso.us/css/syntax.css">
  <link rel="stylesheet" href="https://ikso.us/css/hyde.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700">

  
  <link rel="apple-touch-icon" sizes="57x57" href="/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192"  href="/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
  <link rel="manifest" href="/manifest.json">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="/ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">
  
  <link href="" rel="alternate" type="application/rss+xml" title="Trenton Broughton" />
  
  <script type="text/javascript">(function(c,a){if(!a.__SV){var b=window;try{var d,m,j,k=b.location,f=k.hash;d=function(a,b){return(m=a.match(RegExp(b+"=([^&]*)")))?m[1]:null};f&&d(f,"state")&&(j=JSON.parse(decodeURIComponent(d(f,"state"))),"mpeditor"===j.action&&(b.sessionStorage.setItem("_mpcehash",f),history.replaceState(j.desiredHash||"",c.title,k.pathname+k.search)))}catch(n){}var l,h;window.mixpanel=a;a._i=[];a.init=function(b,d,g){function c(b,i){var a=i.split(".");2==a.length&&(b=b[a[0]],i=a[1]);b[i]=function(){b.push([i].concat(Array.prototype.slice.call(arguments,
  0)))}}var e=a;"undefined"!==typeof g?e=a[g]=[]:g="mixpanel";e.people=e.people||[];e.toString=function(b){var a="mixpanel";"mixpanel"!==g&&(a+="."+g);b||(a+=" (stub)");return a};e.people.toString=function(){return e.toString(1)+".people (stub)"};l="disable time_event track track_pageview track_links track_forms track_with_groups add_group set_group remove_group register register_once alias unregister identify name_tag set_config reset opt_in_tracking opt_out_tracking has_opted_in_tracking has_opted_out_tracking clear_opt_in_out_tracking people.set people.set_once people.unset people.increment people.append people.union people.track_charge people.clear_charges people.delete_user people.remove".split(" ");
  for(h=0;h<l.length;h++)c(e,l[h]);var f="set set_once union unset remove delete".split(" ");e.get_group=function(){function a(c){b[c]=function(){call2_args=arguments;call2=[c].concat(Array.prototype.slice.call(call2_args,0));e.push([d,call2])}}for(var b={},d=["get_group"].concat(Array.prototype.slice.call(arguments,0)),c=0;c<f.length;c++)a(f[c]);return b};a._i.push([b,d,g])};a.__SV=1.2;b=c.createElement("script");b.type="text/javascript";b.async=!0;b.src="undefined"!==typeof MIXPANEL_CUSTOM_LIB_URL?
  MIXPANEL_CUSTOM_LIB_URL:"file:"===c.location.protocol&&"//cdn4.mxpnl.com/libs/mixpanel-2-latest.min.js".match(/^\/\//)?"https://cdn4.mxpnl.com/libs/mixpanel-2-latest.min.js":"//cdn4.mxpnl.com/libs/mixpanel-2-latest.min.js";d=c.getElementsByTagName("script")[0];d.parentNode.insertBefore(b,d)}})(document,window.mixpanel||[]);
  mixpanel.init("91c8afbed5c11f8feee5b2d5f28de5d5");</script>
  
</head>

  <body class=" ">
  <div class="sidebar" id="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="https://ikso.us/"><h1>Trenton Broughton</h1></a>
      <p class="lead">
       danger: high entropy 
      </p>
    </div>

    <ul class="sidebar-nav">
      <li><a href="https://ikso.us/">Home</a> </li>
      <li><a href="/posts/about/"> About Me </a></li><li><a href="/posts/"> Blahg Posts </a></li><li><a href="/machine/"> Machine </a></li>
    </ul>

    <p>&copy; 2018. All rights reserved. </p>
  </div>
</div>

    <div class="content container">
    <div class="post">
  <h1>Attaching StringIO Data to a Mailgun Message</h1>
  <span class="post-date">Thu, Dec 19, 2013</span>
  
  <a class="post-tag" href='/tags/code'>code</a>
  <a class="post-tag" href='/tags/python'>python</a> <p>Recently i started using <a href="http://www.mailgun.com" title="Mailgun by Rackspace">Mailgun</a> for our outgoing messages. They have a very nice   <a href="http://documentation.mailgun.com" title="Mailgun API documentation">API</a>, and take a lot of the heavy lifting out of creating multipart messages.</p>

<p>If you are using <a href="http://docs.python-requests.org/en/latest/" title="Python Requests library">requests</a> (or <a href="https://github.com/dreid/treq/" title="Python Twisted Requests">treq</a>) to send the messages through their REST API, however, you may have noticed that you must specify &ldquo;attachment&rdquo; as the key, and an open file handle as the value. This works great if you are sending files from the filesystem, but if you need to send generated or in memory data as a file attachment, it just doesn&rsquo;t work. Added a <code>name</code> attribute to the StringIO class does the trick:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">NamedStringIO</span>(StringIO):
    name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;&#39;</span>

    <span style="color:#66d9ef">def</span> __init__(self, data, name<span style="color:#f92672">=</span>None):
        <span style="color:#66d9ef">if</span> name:
            self<span style="color:#f92672">.</span>name <span style="color:#f92672">=</span> name
        StringIO<span style="color:#f92672">.</span>__init__(self, data)</code></pre></div>
<p>Now using their <a href="http://documentation.mailgun.com/quickstart.html#sending-messages" title="Mailgun example: sending a message">example</a> will work:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> paste.util <span style="color:#f92672">import</span> MultiDict

good <span style="color:#f92672">=</span> NamedStringIO(<span style="color:#e6db74">&#34;This is some good data&#34;</span>, <span style="color:#e6db74">&#34;good.txt&#34;</span>)
more <span style="color:#f92672">=</span> NamedStringIO(<span style="color:#e6db74">&#34;This is some more good data&#34;</span>, <span style="color:#e6db74">&#34;more.txt&#34;</span>)

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">send_complex_message</span>():
    <span style="color:#66d9ef">return</span> requests<span style="color:#f92672">.</span>post(
        <span style="color:#e6db74">&#34;https://api.mailgun.net/v2/samples.mailgun.org/messages&#34;</span>,
        auth<span style="color:#f92672">=</span>(<span style="color:#e6db74">&#34;api&#34;</span>, <span style="color:#e6db74">&#34;key-PUT_YER_KEY_HERE&#34;</span>),
        files<span style="color:#f92672">=</span>MultiDict([(<span style="color:#e6db74">&#34;attachment&#34;</span>, good),
                         (<span style="color:#e6db74">&#34;attachment&#34;</span>, more)]),
        data<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#34;from&#34;</span>: <span style="color:#e6db74">&#34;Excited User &lt;me@samples.mailgun.org&gt;&#34;</span>,
              <span style="color:#e6db74">&#34;to&#34;</span>: <span style="color:#e6db74">&#34;foo@example.com&#34;</span>,
              <span style="color:#e6db74">&#34;cc&#34;</span>: <span style="color:#e6db74">&#34;baz@example.com&#34;</span>,
              <span style="color:#e6db74">&#34;bcc&#34;</span>: <span style="color:#e6db74">&#34;bar@example.com&#34;</span>,
              <span style="color:#e6db74">&#34;subject&#34;</span>: <span style="color:#e6db74">&#34;Hello&#34;</span>,
              <span style="color:#e6db74">&#34;text&#34;</span>: <span style="color:#e6db74">&#34;Testing some Mailgun awesomness!&#34;</span>,
              <span style="color:#e6db74">&#34;html&#34;</span>: <span style="color:#e6db74">&#34;&lt;html&gt;HTML version of the body&lt;/html&gt;&#34;</span>})</code></pre></div>
</div>


    </div>

    
    
    <script>
      mixpanel.track("Page View", {page: "\/posts\/2013-12-19-22-48\/"});
    </script>
    
  </body>
</html>